---
title: "Homework 6"
author: "Zeqi Li"
date: "2024-12-02"
output: github_document
---

```{r setup, include = FALSE}
library(tidyverse)
library(modelr)
```

# Problem 1
## Import weather data
```{r p1_data, message = FALSE}
weather_df = 
  rnoaa::meteo_pull_monitors(
    c("USW00094728"),
    var = c("PRCP", "TMIN", "TMAX"), 
    date_min = "2017-01-01",
    date_max = "2017-12-31") |> 
  mutate(
    name = recode(id, USW00094728 = "CentralPark_NY"),
    tmin = tmin / 10,
    tmax = tmax / 10) |> 
  select(name, id, everything())
```

## Perform bootstrapping
```{r p1_bootstrap}
bootstrap = function(df) {
  sample_frac(df, replace = TRUE) 
}

boot_samp = tibble(n = 1:5000) |> 
  mutate(strap_samp = map(n, \(i) bootstrap(df = weather_df)))
```

## Build a simple linear regression model
```{r p1_slr}
boot_slr = boot_samp |> 
  mutate(models = map(strap_samp, \(df) lm(tmax ~ tmin, data = df))) |> 
  select(-strap_samp)
```

## Extract $r^2$ and $log(\hat{\beta_{0}} * \hat{\beta_{1}})$ estimates
```{r p1_estimates}
boot_res = boot_slr |> 
  mutate(tidy_res = map(models, broom::tidy),
         glance_res = map(models, broom::glance)) |> 
  select(-models) |> 
  unnest(cols = c(tidy_res, glance_res),
         names_sep = "_")

est_df = boot_res |> 
  select(n, 
         tidy_res_term,
         tidy_res_estimate,
         glance_res_r.squared) |> 
  group_by(tidy_res_term) |> 
  pivot_wider(names_from = tidy_res_term,
              values_from = tidy_res_estimate) |> 
  rename(r_sq = glance_res_r.squared,
         beta_0 = `(Intercept)`,
         beta_1 = tmin) |> 
  mutate(log_betas = log(beta_0 * beta_1)) |> 
  select(-beta_0, -beta_1)
```

## Compute confidence intervals using all bootstrap samples
```{r p1_ci, warning = FALSE}
ci_df = est_df |> 
  summarize(r_sq_lb = quantile(r_sq, 0.025),
            r_sq_ub = quantile(r_sq, 0.975),
            log_betas_lb = quantile(log_betas, 0.025),
            log_betas_ub = quantile(log_betas, 0.975))
```

## Plot estimates with confidence intervals
### Histogram for $r^2$
```{r p1_plot1, message = FALSE}
est_df |> 
  ggplot(aes(x = r_sq)) +
  geom_histogram(binwidth = 0.005) +
  geom_vline(aes(xintercept = ci_df$r_sq_lb), 
             color = "blue", 
             linetype = "dashed") +
  geom_vline(aes(xintercept = ci_df$r_sq_ub), 
             color = "blue", 
             linetype = "dashed") +
  labs(title = expression(r^2 ~ " estimate distribution"),
       x = expression(r^2),
       y = "Frequency")
```

COMMENT

### Histogram for $log(\hat{\beta_{0}} * \hat{\beta_{1}})$
```{r p1_plot2, message = FALSE}
est_df |> 
  ggplot(aes(x = log_betas)) +
  geom_histogram(binwidth = 0.005) +
  geom_vline(aes(xintercept = ci_df$log_betas_lb), 
             color = "blue", 
             linetype = "dashed") +
  geom_vline(aes(xintercept = ci_df$log_betas_ub), 
             color = "blue", 
             linetype = "dashed") +
  labs(title = expression(log(beta[0] * beta[1]) ~ " estimate distribution"),
       x = expression(log(beta[0] * beta[1])),
       y = "Frequency")
```

COMMENT

# Problem 2
## Import data from GitHub
```{r p2_import, message = FALSE}
url = "https://raw.githubusercontent.com/washingtonpost/data-homicides/master/homicide-data.csv"

homicide = read_csv(url(url),
                    na = c("", "Unknown"))
```

## Tidy up the `homicide` dataset
```{r p2_tidy}
homicide_tidy = homicide |> 
  mutate(city_state = paste(city, 
                            state, 
                            sep = ", "),
         resolved = as.numeric(disposition == "Closed by arrest"),
         victim_age = as.numeric(victim_age),
         victim_race = fct_relevel(victim_race, "White")) |> 
  filter(!city_state %in% c("Dallas, TX", 
                            "Phoenix, AZ", 
                            "Kansas City, MO", 
                            "Tulsa, AL"),
         victim_race %in% c("White", "Black")) |> 
  select(-city & -state)
```

## Fit a logistic regression for Baltimore data
```{r p2_glm_balt}
baltimore_df = homicide_tidy |> 
  filter(city_state == "Baltimore, MD")

baltimore_model = glm(resolved ~ victim_age + victim_sex + victim_race,
                      family = binomial(link = "logit"),
                      data = baltimore_df)
```

## Compute the adjusted odds ratio between sexes
``` {r p2_or}
baltimore_sum = baltimore_model |> 
  broom::tidy(conf.int = TRUE) |> 
  filter(term == "victim_sexMale") |> 
  mutate(estimate = exp(estimate),
         conf.low = exp(conf.low),
         conf.high = exp(conf.high)) |> 
  select(estimate, 
         conf.low,
         conf.high)

baltimore_sum |> 
  knitr::kable(digits = 3,
               caption = "Adjusted odds ratio and 95% confidence intervals for solving homicides between male and female victims in Baltimore, MD",
               col.names = c("Adjusted odds ratio",
                             "Confidence interval lower limit",
                             "Confidence interval upper limit"))
```


## Fit a logistic regression for all cities
```{r p2_glm_all}
all_model = homicide_tidy |> 
  group_by(city_state) |> 
  nest() |> 
  mutate(model = map(data, ~glm(resolved ~ victim_age + victim_sex + victim_race, 
                                family = binomial(link = "logit"), 
                                data = .x)),
         summary = map(model, ~broom::tidy(.x, 
                                           conf.int = TRUE))) |> 
  unnest(summary) |> 
  filter(term == "victim_sexMale") |> 
  mutate(estimate = exp(estimate),
         conf.low = exp(conf.low),
         conf.high = exp(conf.high)) |> 
  select(city_state,
         estimate,
         conf.low,
         conf.high)
```

## Plot adjusted odds ratios across all cities
```{r p2_plot, message = FALSE}
all_model |> 
  arrange(estimate) |> 
  ggplot(aes(x = reorder(city_state, estimate),
             y = estimate)) +
  geom_point() +
  geom_errorbar(aes(ymin = conf.low,
                    ymax = conf.high)) +
  labs(title = "Adjusted odds ratios of solved homicides between sexes",
       x = "City",
       y = "Adjusted odds ratio") +
  theme(axis.text.x = element_text(angle = 90,
                                   vjust = 0.5,
                                   hjust = 1))
```

COMMENT

# Problem 3
## Import data
```{r p3_data, messgae = FALSE}
bwt_df = read_csv("data/birthweight.csv") |> 
  janitor::clean_names() |> 
  mutate(babysex = case_match(babysex,
                              1 ~ "male",
                              2 ~ "female"),
         babysex = fct_infreq(babysex),
         frace = case_match(frace,
                            1 ~ "white",
                            2 ~ "black",
                            3 ~ "asian",
                            4 ~ "puerto rican",
                            8 ~ "other",
                            9 ~ NA),
         frace = fct_infreq(frace),
         mrace = case_match(mrace,
                            1 ~ "white",
                            2 ~ "black",
                            3 ~ "asian",
                            4 ~ "puerto rican",
                            8 ~ "other"),
         mrace = fct_infreq(mrace),
         malform = case_match(malform,
                              0 ~ "absent",
                              1 ~ "present"),
         malform = fct_infreq(malform))
```

## Building a model for birthweight
Based on prior knowledge about physiological factors that would influence infants' birth weight, I decided to fit.a multiple linear regression, using `bwt` as response and `delwt`, `gaweeks`, `malform`, `smoken`, and `wtgain` as the predictors. I hypothesize that `delwt`, `gaweeks`, and `wtgain` would positively influence `bwt`, while `malform` and `smoken` would negatively inflience `bwt`.
```{r p3_model1}
bwt_lm1 = lm(bwt ~ delwt + gaweeks + malform + smoken + wtgain,
             data = bwt_df)

bwt_lm1 |> 
  broom::tidy() |> 
  select(term, estimate, p.value)
```

## Plot model residuals of my proposed model
```{r p3_resid_plot}
bwt_df |> 
  add_residuals(bwt_lm1) |> 
  add_predictions(bwt_lm1) |> 
  ggplot(aes(x = pred,
             y = resid)) +
  geom_point(alpha = 0.5) + 
  geom_hline(yintercept = 0,
             color = "blue",
             linetype = "dashed") + 
  labs(title = "Residual plot of proposed multiple linear regression model on birthweight",
       x = "Prediction",
       y = "Residual")
```
From the residual plot above, we can see that the points are roughly symmetrical around the `residual=0` line and randomly scattered without a particular pattern. Therefore, we can conclude that the proposed linear model is appropriate for predicting `bwt`.

## Compare proposed model to other models
### Split into training and testing datasets
```{r p3_split}
cv_df = crossv_mc(bwt_df, 100) |> 
  mutate(train = map(train, as_tibble),
         test = map(test, as_tibble))
```

### Build models
```{r p3_model, eval = FALSE}
cv_df = cv_df |> 
  mutate(lm1 = map(train, 
                   \(df) lm(bwt ~ delwt + gaweeks + malform + smoken + wtgain,
                            data = df)),
         lm2 = map(train, 
                   \(df) lm(bwt ~ blength + gaweeks,
                            data = df)),
         lm3 = map(train, 
                   \(df) lm(bwt ~ bhead*blength + bhead*babysex + blength*babysex + bhead*blength*babysex,
                            data = df)))
```

### Compute prediction errors
```{r p3_rmse}
cv_df = cv_df |> 
  mutate(rmse_lm1 = map2_dbl(lm1, 
                             test,
                             \(mod, df) rmse(model = mod,
                                             data = df)),
         rmse_lm2 = map2_dbl(lm2, 
                             test,
                             \(mod, df) rmse(model = mod,
                                             data = df)),
         rmse_lm3 = map2_dbl(lm3, 
                             test,
                             \(mod, df) rmse(model = mod,
                                             data = df))) |> 
  select(starts_with("rmse")) |> 
  pivot_longer(everything(),
               names_to = "model",
               values_to = "rmse",
               names_prefix = "rmse_") |> 
  mutate(model = fct_inorder(model))
```

### Plot prediction errors
```{r p3_rmse_plot}
cv_df |> 
  ggplot(aes(x = model,
             y = rmse)) +
  geom_violin() +
  labs(title = "Violin plot of prediction error distributions for candidate models",
       x = "Model",
       y = "RMSE")
```

COMMENT